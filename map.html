<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø®Ø±ÙŠØ·Ø© Ø£Ù…Ø§ÙƒÙ† Ø§Ù„Ø±ÙŠØ§Ø¶ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© | ÙˆÙŠÙ† Ù†Ø±ÙˆØ­ Ø¨Ø§Ù„Ø±ÙŠØ§Ø¶ØŸ</title>
  <meta name="description" content="Ø®Ø±ÙŠØ·Ø© ØªÙØ§Ø¹Ù„ÙŠØ© Ù„Ø£ÙØ¶Ù„ Ø£Ù…Ø§ÙƒÙ† Ø§Ù„Ø±ÙŠØ§Ø¶. Ø§ÙƒØªØ´Ù Ø§Ù„ÙƒØ§ÙÙŠÙ‡Ø§Øª ÙˆØ§Ù„Ù…Ø·Ø§Ø¹Ù… ÙˆØ§Ù„Ø£Ù…Ø§ÙƒÙ† Ø§Ù„ØªØ±ÙÙŠÙ‡ÙŠØ© Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© Ù…Ù†Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.">
  <link rel="canonical" href="https://wain-nrooh.com/map.html">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0a1628">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    #map-container {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 20px;
    }
    #map {
      width: 100%;
      height: 70vh;
      min-height: 400px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      z-index: 1;
    }
    .map-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
      align-items: center;
    }
    .map-filter-chip {
      padding: 8px 16px;
      border: 2px solid var(--border);
      border-radius: 50px;
      background: var(--card-bg);
      cursor: pointer;
      font-family: 'Tajawal', sans-serif;
      font-size: 13px;
      font-weight: 600;
      transition: var(--transition);
      color: var(--text);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      min-height: 40px;
      white-space: nowrap;
    }
    .map-filter-chip:hover {
      border-color: var(--gold);
      color: var(--gold-dark);
    }
    .map-filter-chip.active {
      background: var(--gold);
      border-color: var(--gold);
      color: var(--primary);
    }
    .map-locate-btn {
      padding: 8px 18px;
      background: var(--primary);
      color: var(--gold);
      border: 2px solid var(--primary);
      border-radius: 50px;
      cursor: pointer;
      font-family: 'Tajawal', sans-serif;
      font-size: 13px;
      font-weight: 700;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      min-height: 40px;
      margin-right: auto;
    }
    .map-locate-btn:hover {
      background: var(--primary-light);
      transform: translateY(-1px);
    }
    .map-locate-btn.locating {
      opacity: 0.7;
      pointer-events: none;
    }
    .map-stats {
      display: flex;
      gap: 16px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    .map-stat {
      background: var(--card-bg);
      padding: 12px 20px;
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow);
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      border-top: 3px solid var(--gold);
    }
    .map-stat strong {
      color: var(--gold-dark);
      font-size: 18px;
    }
    /* Leaflet popup styling */
    .leaflet-popup-content-wrapper {
      border-radius: var(--radius-sm) !important;
      font-family: 'Tajawal', sans-serif !important;
      direction: rtl;
    }
    .leaflet-popup-content {
      margin: 12px 16px !important;
      font-size: 14px;
      line-height: 1.6;
      min-width: 220px;
    }
    .popup-name {
      font-size: 16px;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 4px;
    }
    .popup-category {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }
    .popup-rating {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }
    .popup-rating .stars {
      color: var(--gold);
      font-size: 13px;
    }
    .popup-rating .score {
      font-weight: 800;
      color: var(--primary);
    }
    .popup-desc {
      font-size: 13px;
      color: var(--text-light);
      margin-bottom: 8px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .popup-actions {
      display: flex;
      gap: 8px;
    }
    .popup-actions a {
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 700;
      text-decoration: none;
      transition: var(--transition);
    }
    .popup-link {
      background: var(--gold);
      color: var(--primary);
    }
    .popup-map-link {
      background: rgba(10,22,40,0.06);
      color: var(--primary);
    }
    .popup-trending {
      display: inline-block;
      background: var(--gold);
      color: var(--primary);
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    /* Heat Legend */
    .heat-legend {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 10px 16px;
      background: var(--card-bg);
      border-radius: var(--radius-sm);
      margin-bottom: 10px;
      box-shadow: var(--shadow);
      font-size: 13px;
      flex-wrap: wrap;
    }
    .hl-title { font-weight: 700; color: var(--primary); }
    .hl-item { display: inline-flex; align-items: center; gap: 5px; color: var(--text-light); }
    .hl-dot { width: 12px; height: 12px; border-radius: 50%; }
    .heat-marker-inner:hover { transform: scale(1.15); }

    @media (max-width: 768px) {
      #map-container { padding: 12px; }
      #map { height: 60vh; min-height: 350px; }
      .map-controls { gap: 6px; }
      .map-filter-chip { padding: 6px 12px; font-size: 12px; min-height: 36px; }
      .map-locate-btn { padding: 6px 14px; font-size: 12px; min-height: 36px; }
      .map-stats { gap: 8px; }
      .map-stat { padding: 8px 14px; font-size: 13px; }
    }
  </style>
  <link rel="stylesheet" href="css/ramadan.css">
  <link rel="stylesheet" href="css/search-header.css">
</head>
<body>

  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="logo"><span>ğŸ™ï¸</span><h1>ÙˆÙŠÙ† Ù†Ø±ÙˆØ­ Ø¨Ø§Ù„Ø±ÙŠØ§Ø¶ØŸ</h1></a>
      <button class="dark-mode-toggle" aria-label="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ">ğŸŒ™</button>
      <button class="menu-toggle" aria-label="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">â˜°</button>
      <nav class="nav">
        <a href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <a href="cafes.html">ÙƒØ§ÙÙŠÙ‡Ø§Øª</a>
        <a href="restaurants.html">Ù…Ø·Ø§Ø¹Ù…</a>
        <a href="activities.html">ØªØ±ÙÙŠÙ‡</a>
        <a href="events.html">ÙØ¹Ø§Ù„ÙŠØ§Øª</a>
        <a href="new-places.html">Ø¬Ø¯ÙŠØ¯</a>
        <a href="discover.html">ğŸ² ÙˆÙŠÙ† Ù†Ø±ÙˆØ­ØŸ</a>
        <div class="nav-dropdown">
          <a href="#">Ø§Ù„Ù…Ø²ÙŠØ¯</a>
          <div class="dropdown-menu">
            <a href="shopping.html">ğŸ›ï¸ ØªØ³ÙˆÙ‚</a>
            <a href="nature.html">ğŸï¸ Ø·Ø¨ÙŠØ¹Ø©</a>
            <a href="desserts.html">ğŸ° Ø­Ù„ÙˆÙŠØ§Øª</a>
            <a href="top-rated.html">â­ Ø§Ù„Ø£Ø¹Ù„Ù‰ ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹</a>
            <div class="dropdown-divider"></div>
            <a href="foundation-day.html">ğŸ‡¸ğŸ‡¦ ÙŠÙˆÙ… Ø§Ù„ØªØ£Ø³ÙŠØ³</a>
            <a href="riyadh-season.html">âœ¨ Ù…ÙˆØ³Ù… Ø§Ù„Ø±ÙŠØ§Ø¶</a>
            <div class="dropdown-divider"></div>
            <div class="dropdown-submenu">
              <a href="#">ğŸ˜ï¸ Ø§Ù„Ø£Ø­ÙŠØ§Ø¡</a>
              <div class="submenu">
                <a href="neighborhood-olaya.html">Ø­ÙŠ Ø§Ù„Ø¹Ù„ÙŠØ§</a>
                <a href="neighborhood-malqa.html">Ø­ÙŠ Ø§Ù„Ù…Ù„Ù‚Ø§</a>
                <a href="neighborhood-hittin.html">Ø­ÙŠ Ø­Ø·ÙŠÙ†</a>
                <a href="neighborhood-yasmin.html">Ø­ÙŠ Ø§Ù„ÙŠØ§Ø³Ù…ÙŠÙ†</a>
                <a href="neighborhood-rabee.html">Ø­ÙŠ Ø§Ù„Ø±Ø¨ÙŠØ¹</a>
              </div>
            </div>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <section class="page-header">
    <h2>ğŸ—ºï¸ Ø®Ø±ÙŠØ·Ø© Ø£Ù…Ø§ÙƒÙ† <span>Ø§Ù„Ø±ÙŠØ§Ø¶</span></h2>
    <p>Ø§ÙƒØªØ´Ù Ø£Ù‚Ø±Ø¨ Ø§Ù„Ø£Ù…Ø§ÙƒÙ† Ø§Ù„Ù…Ù…ÙŠØ²Ø© Ø¥Ù„ÙŠÙƒ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</p>
  </section>

  <div id="map-container">
    <div class="map-controls" id="map-controls">
      <button class="map-filter-chip active" data-category="all">ğŸ“ Ø§Ù„ÙƒÙ„</button>
      <button class="map-filter-chip" data-category="ÙƒØ§ÙÙŠÙ‡">â˜• ÙƒØ§ÙÙŠÙ‡Ø§Øª</button>
      <button class="map-filter-chip" data-category="Ù…Ø·Ø¹Ù…">ğŸ½ï¸ Ù…Ø·Ø§Ø¹Ù…</button>
      <button class="map-filter-chip" data-category="ØªØ±ÙÙŠÙ‡">ğŸ­ ØªØ±ÙÙŠÙ‡</button>
      <button class="map-filter-chip" data-category="ØªØ³ÙˆÙ‚">ğŸ›ï¸ ØªØ³ÙˆÙ‚</button>
      <button class="map-filter-chip" data-category="Ø·Ø¨ÙŠØ¹Ø©">ğŸï¸ Ø·Ø¨ÙŠØ¹Ø©</button>
      <button class="map-filter-chip" data-category="Ø­Ù„ÙˆÙŠØ§Øª">ğŸ° Ø­Ù„ÙˆÙŠØ§Øª</button>
      <button class="map-filter-chip" data-category="ÙØ¹Ø§Ù„ÙŠØ§Øª">ğŸª ÙØ¹Ø§Ù„ÙŠØ§Øª</button>
      <button class="map-filter-chip" id="heat-toggle" data-category="heat" style="border-color:#e74c3c;color:#e74c3c;">ğŸ”¥ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©</button>
      <button class="map-locate-btn" id="locate-btn">ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ</button>
    </div>

    <!-- Heat Legend (hidden by default) -->
    <div id="heat-legend" class="heat-legend" style="display:none;">
      <span class="hl-title">Ù…ÙØªØ§Ø­ Ø§Ù„Ø­Ø±Ø§Ø±Ø©:</span>
      <span class="hl-item"><span class="hl-dot" style="background:#e74c3c;"></span> Ø­Ø§Ø± Ø¬Ø¯Ø§Ù‹</span>
      <span class="hl-item"><span class="hl-dot" style="background:#f39c12;"></span> Ø±Ø§Ø¦Ø¬</span>
      <span class="hl-item"><span class="hl-dot" style="background:#2ecc71;"></span> Ø¹Ø§Ø¯ÙŠ</span>
    </div>

    <div id="map"></div>

    <div class="map-stats" id="map-stats"></div>
  </div>

  <footer class="footer">
    <div class="footer-inner">
      <div>
        <h3>ÙˆÙŠÙ† Ù†Ø±ÙˆØ­ Ø¨Ø§Ù„Ø±ÙŠØ§Ø¶ØŸ</h3>
        <p>Ø¯Ù„ÙŠÙ„Ùƒ Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ù…Ø§ÙƒÙ† ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶. Ù…Ø­Ø¯Ø« ÙŠÙˆÙ…ÙŠØ§Ù‹.</p>
      </div>
      <div>
        <h3>Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h3>
        <ul>
          <li><a href="cafes.html">ÙƒØ§ÙÙŠÙ‡Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶</a></li>
          <li><a href="restaurants.html">Ù…Ø·Ø§Ø¹Ù… Ø§Ù„Ø±ÙŠØ§Ø¶</a></li>
          <li><a href="activities.html">ØªØ±ÙÙŠÙ‡ ÙˆØ£Ù†Ø´Ø·Ø©</a></li>
          <li><a href="map.html">ğŸ—ºï¸ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a></li>
          <li><a href="favorites.html">â¤ï¸ Ø§Ù„Ù…ÙØ¶Ù„Ø©</a></li>
        </ul>
      </div>
      <div>
        <h3>Ø±ÙˆØ§Ø¨Ø· Ù…ÙÙŠØ¯Ø©</h3>
        <ul>
          <li><a href="sitemap.xml">Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹</a></li>
          <li><a href="#">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a></li>
          <li><a href="#">ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</a></li>
        </ul>
      </div>
    </div>
    <div class="footer-heart">ØµÙ†Ø¹ Ø¨Ù€ <span>â¤ï¸</span> ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶</div>
    <div class="footer-bottom"><p>Â© 2025-2026 ÙˆÙŠÙ† Ù†Ø±ÙˆØ­ Ø¨Ø§Ù„Ø±ÙŠØ§Ø¶ØŸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p></div>
  </footer>

  <button class="scroll-top" id="scrollTop" aria-label="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰">â†‘</button>

  <script src="js/darkmode.js"></script>
  <script src="js/main.js"></script>
  <script src="js/crowd.js"></script>
  <script src="js/hotness.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    const CATEGORY_COLORS = {
      'ÙƒØ§ÙÙŠÙ‡':   { color: '#8B4513', icon: 'â˜•', bg: '#F5DEB3' },
      'Ù…Ø·Ø¹Ù…':    { color: '#DC143C', icon: 'ğŸ½ï¸', bg: '#FFE4E1' },
      'ØªØ±ÙÙŠÙ‡':   { color: '#4B0082', icon: 'ğŸ­', bg: '#E6E6FA' },
      'ØªØ³ÙˆÙ‚':    { color: '#FF69B4', icon: 'ğŸ›ï¸', bg: '#FFF0F5' },
      'Ø·Ø¨ÙŠØ¹Ø©':   { color: '#228B22', icon: 'ğŸï¸', bg: '#F0FFF0' },
      'Ø­Ù„ÙˆÙŠØ§Øª':  { color: '#FF8C00', icon: 'ğŸ°', bg: '#FFF8DC' },
      'ÙØ¹Ø§Ù„ÙŠØ§Øª': { color: '#4169E1', icon: 'ğŸª', bg: '#F0F8FF' },
    };

    function createCategoryIcon(category) {
      const cat = CATEGORY_COLORS[category] || { color: '#c9a84c', icon: 'ğŸ“', bg: '#fff' };
      return L.divIcon({
        html: `<div style="
          background:${cat.bg};
          border:3px solid ${cat.color};
          border-radius:50%;
          width:36px;height:36px;
          display:flex;align-items:center;justify-content:center;
          font-size:18px;
          box-shadow:0 2px 8px rgba(0,0,0,0.25);
        ">${cat.icon}</div>`,
        className: 'custom-marker',
        iconSize: [36, 36],
        iconAnchor: [18, 18],
        popupAnchor: [0, -20],
      });
    }

    function createPopupContent(place) {
      const stars = 'â˜…'.repeat(Math.floor(place.google_rating)) + (place.google_rating % 1 >= 0.3 ? 'â˜…' : '') + 'â˜†'.repeat(5 - Math.floor(place.google_rating) - (place.google_rating % 1 >= 0.3 ? 1 : 0));
      const catNames = { 'ÙƒØ§ÙÙŠÙ‡': 'ÙƒØ§ÙÙŠÙ‡', 'Ù…Ø·Ø¹Ù…': 'Ù…Ø·Ø¹Ù…', 'ØªØ±ÙÙŠÙ‡': 'ØªØ±ÙÙŠÙ‡', 'ØªØ³ÙˆÙ‚': 'ØªØ³ÙˆÙ‚', 'Ø·Ø¨ÙŠØ¹Ø©': 'Ø·Ø¨ÙŠØ¹Ø©', 'Ø­Ù„ÙˆÙŠØ§Øª': 'Ø­Ù„ÙˆÙŠØ§Øª', 'ÙØ¹Ø§Ù„ÙŠØ§Øª': 'ÙØ¹Ø§Ù„ÙŠØ§Øª' };
      return `
        <div>
          ${place.trending ? '<span class="popup-trending">ğŸ”¥ Ø±Ø§Ø¦Ø¬</span>' : ''}
          <div class="popup-name">${place.name_ar}</div>
          <div class="popup-category">${CATEGORY_COLORS[place.category]?.icon || 'ğŸ“'} ${catNames[place.category] || place.category} Â· ${place.neighborhood}</div>
          <div class="popup-rating">
            <span class="score">${place.google_rating}</span>
            <span class="stars">${stars}</span>
            <span style="font-size:12px;color:#888;">(${place.review_count.toLocaleString('ar-SA')})</span>
          </div>
          <div class="popup-desc">${place.description_ar}</div>
          <div style="font-size:13px;color:var(--gold-dark);font-weight:700;margin-bottom:8px;">${place.price_level}</div>
          <div class="popup-actions">
            <a href="place.html?id=${place.id}" class="popup-link">Ø§Ø¹Ø±Ù Ø£ÙƒØ«Ø±</a>
            <a href="${place.google_maps_url}" target="_blank" class="popup-map-link">ğŸ“ Ø®Ø±Ø§Ø¦Ø· Ù‚ÙˆÙ‚Ù„</a>
          </div>
        </div>
      `;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const places = await loadPlaces();

      // Initialize map centered on Riyadh
      const map = L.map('map', {
        zoomControl: true,
      }).setView([24.7136, 46.6753], 11);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap',
        maxZoom: 18,
      }).addTo(map);

      // Create marker cluster group
      const clusterGroup = L.markerClusterGroup({
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        chunkedLoading: true,
        iconCreateFunction: function(cluster) {
          const count = cluster.getChildCount();
          let size = 'small';
          if (count > 10) size = 'medium';
          if (count > 50) size = 'large';
          const sizes = { small: 36, medium: 44, large: 52 };
          return L.divIcon({
            html: `<div style="
              background:linear-gradient(135deg, #c9a84c, #b08d3a);
              color:#0a1628;
              border-radius:50%;
              width:${sizes[size]}px;height:${sizes[size]}px;
              display:flex;align-items:center;justify-content:center;
              font-size:${size === 'large' ? 16 : 14}px;
              font-weight:900;
              font-family:'Tajawal',sans-serif;
              box-shadow:0 3px 12px rgba(201,168,76,0.4);
              border:3px solid #0a1628;
            ">${count}</div>`,
            className: 'custom-cluster',
            iconSize: [sizes[size], sizes[size]],
          });
        }
      });

      // Create markers
      const allMarkers = {};
      places.forEach(place => {
        if (!place.lat || !place.lng) return;
        const marker = L.marker([place.lat, place.lng], {
          icon: createCategoryIcon(place.category),
        });
        marker.bindPopup(createPopupContent(place), { maxWidth: 300 });
        marker.placeData = place;
        if (!allMarkers[place.category]) allMarkers[place.category] = [];
        allMarkers[place.category].push(marker);
      });

      // Add all markers initially
      Object.values(allMarkers).flat().forEach(m => clusterGroup.addLayer(m));
      map.addLayer(clusterGroup);

      // Category filter
      let activeCategory = 'all';
      document.querySelectorAll('.map-filter-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          document.querySelectorAll('.map-filter-chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          activeCategory = chip.dataset.category;

          clusterGroup.clearLayers();
          if (activeCategory === 'all') {
            Object.values(allMarkers).flat().forEach(m => clusterGroup.addLayer(m));
          } else {
            (allMarkers[activeCategory] || []).forEach(m => clusterGroup.addLayer(m));
          }

          updateStats(activeCategory);
        });
      });

      // Location button
      const locateBtn = document.getElementById('locate-btn');
      let userMarker = null;

      locateBtn.addEventListener('click', () => {
        if (!navigator.geolocation) {
          alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹');
          return;
        }
        locateBtn.classList.add('locating');
        locateBtn.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯...';

        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;
            if (userMarker) map.removeLayer(userMarker);

            userMarker = L.marker([latitude, longitude], {
              icon: L.divIcon({
                html: `<div style="
                  width:20px;height:20px;
                  background:#4285F4;
                  border:4px solid white;
                  border-radius:50%;
                  box-shadow:0 2px 8px rgba(66,133,244,0.5);
                "></div>`,
                className: 'user-marker',
                iconSize: [20, 20],
                iconAnchor: [10, 10],
              })
            }).addTo(map);

            userMarker.bindPopup('<div style="text-align:center;font-family:Tajawal,sans-serif;"><strong>ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</strong></div>').openPopup();
            map.setView([latitude, longitude], 14);

            locateBtn.classList.remove('locating');
            locateBtn.innerHTML = 'ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ';
          },
          (err) => {
            locateBtn.classList.remove('locating');
            locateBtn.innerHTML = 'ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ';
            alert('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹.');
          },
          { enableHighAccuracy: true, timeout: 10000 }
        );
      });

      // Stats
      function updateStats(category) {
        const filtered = category === 'all' ? places : places.filter(p => p.category === category);
        const avgRating = (filtered.reduce((s, p) => s + p.google_rating, 0) / filtered.length).toFixed(1);
        const trending = filtered.filter(p => p.trending).length;
        document.getElementById('map-stats').innerHTML = `
          <div class="map-stat">ğŸ“ <strong>${filtered.length}</strong> Ù…ÙƒØ§Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</div>
          <div class="map-stat">â­ Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ… <strong>${avgRating}</strong></div>
          <div class="map-stat">ğŸ”¥ <strong>${trending}</strong> Ø±Ø§Ø¦Ø¬ Ø§Ù„Ø¢Ù†</div>
        `;
      }
      updateStats('all');
    });
  </script>
  <script>
    document.querySelectorAll('.nav-dropdown > a').forEach(a => {
      a.addEventListener('click', (e) => {
        if (window.innerWidth <= 768) {
          e.preventDefault();
          a.parentElement.classList.toggle('open');
        }
      });
    });
    document.querySelectorAll('.dropdown-submenu > a').forEach(a => {
      a.addEventListener('click', (e) => {
        if (window.innerWidth <= 768) {
          e.preventDefault();
          a.nextElementSibling.style.display = a.nextElementSibling.style.display === 'block' ? 'none' : 'block';
        }
      });
    });
  </script>
  <script src="js/analytics.js"></script>
  <script src="js/ramadan.js"></script>
</body>
</html>
