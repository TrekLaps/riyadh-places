# Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª â€” SHA-locked | Rerun dedupe | Browser evidence
name: Risk Policy Gate
on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]
permissions:
  contents: write
  pull-requests: write

jobs:
  policy-gate:
    name: "ğŸ”’ Policy Gate"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Extract HEAD SHA
        id: sha
        run: |
          echo "head_sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          echo "short=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      - name: Validate JSON + Places
        id: data
        run: |
          python3 << 'PYEOF'
          import json, glob, os, sys
          errors = 0
          for f in glob.glob('data/*.json'):
              try: json.load(open(f))
              except: errors += 1; print(f"âŒ {f}")
          data = json.load(open('data/places.json'))
          places = data if isinstance(data, list) else data.get('places', [])
          for i, p in enumerate(places):
              if not (p.get('name') or p.get('name_ar')): errors += 1
              if not (p.get('category') or p.get('category_ar')): errors += 1
          print(f"{'âŒ' if errors else 'âœ…'} {len(places)} places, {errors} errors")
          with open(os.environ['GITHUB_OUTPUT'], 'a') as o: o.write(f"errors={errors}\n")
          sys.exit(1 if errors else 0)
          PYEOF

      - name: Check internal links
        id: links
        run: |
          python3 << 'PYEOF'
          import os, re, glob, sys
          broken = sum(1 for f in glob.glob('*.html')
            for link in re.findall(r'href="([^"]*\.html)"', open(f, encoding='utf-8', errors='ignore').read())
            if not link.startswith('http') and not os.path.exists(link))
          print(f"{'âŒ' if broken else 'âœ…'} Links: {broken} broken")
          with open(os.environ['GITHUB_OUTPUT'], 'a') as o: o.write(f"broken={broken}\n")
          sys.exit(1 if broken else 0)
          PYEOF

      - name: Security scan
        run: |
          if grep -rn "api_key\|secret_key\|password.*=" --include="*.js" --include="*.json" \
             --include="*.html" . 2>/dev/null | grep -v node_modules | grep -iv "placeholder\|example\|test\|todo"; then
            echo "âš ï¸ Potential secrets"; exit 1
          fi
          echo "âœ… Clean"

      - name: Validate HTML & JS
        run: |
          for f in *.html; do grep -q "<!DOCTYPE html>" "$f" || echo "âš ï¸ $f: no DOCTYPE"; done
          if [ -d js ]; then for f in js/*.js; do node --check "$f" || exit 1; done; fi

      # ØªÙ‚Ø±ÙŠØ± Ù…Ø¹ dedupe Ø¨Ù€ marker + SHA
      - name: Post validation report
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const marker = '<!-- review-agent-auto-rerun -->';
            const sha = '${{ steps.sha.outputs.short }}';
            const trigger = `sha:${sha}`;
            const {data: comments} = await github.rest.issues.listComments({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: context.issue.number
            });
            if (comments.some(c => c.body.includes(marker) && c.body.includes(trigger))) return;
            const de = '${{ steps.data.outputs.errors }}', bl = '${{ steps.links.outputs.broken }}';
            const ok = de === '0' && bl === '0';
            await github.rest.issues.createComment({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [marker, `## ${ok ? 'âœ…' : 'âŒ'} Policy Gate â€” ${trigger}`,
                `| Check | Result |`, `|---|---|`,
                `| Data | ${de === '0' ? 'âœ…' : 'âŒ '+de+' errors'} |`,
                `| Links | ${bl === '0' ? 'âœ…' : 'âŒ '+bl+' broken'} |`,
                `| Security | âœ… |`,
                `\n*\`${{ steps.sha.outputs.head_sha }}\`*`].join('\n')
            });
