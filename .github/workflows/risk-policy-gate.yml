# Risk Policy Gate — CI/CD Review Agent Pattern
# Based on: CI-REVIEW-PATTERNS.md (mandatory for all projects)
# SHA-locked reviews, single rerun writer, remediation loop

name: Risk Policy Gate

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  preflight:
    name: Preflight Gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate JSON Data
        run: |
          echo "=== Validating data files ==="
          for f in data/*.json; do
            python3 -c "import json; json.load(open('$f'))" && echo "✅ $f" || echo "❌ $f INVALID"
          done

      - name: Check for broken internal links
        run: |
          echo "=== Checking HTML links ==="
          python3 << 'PYEOF'
          import os, re, glob
          html_files = glob.glob('*.html')
          broken = []
          for f in html_files:
              with open(f, 'r', encoding='utf-8', errors='ignore') as fh:
                  content = fh.read()
              links = re.findall(r'href="([^"]*\.html)"', content)
              for link in links:
                  if link.startswith('http'): continue
                  target = os.path.normpath(os.path.join(os.path.dirname(f), link))
                  if not os.path.exists(target):
                      broken.append((f, link))
          if broken:
              print(f"❌ {len(broken)} broken links found:")
              for src, link in broken:
                  print(f"  {src} → {link}")
              exit(1)
          else:
              print(f"✅ All links valid across {len(html_files)} HTML files")
          PYEOF

      - name: Validate places.json integrity
        run: |
          python3 << 'PYEOF'
          import json
          data = json.load(open('data/places.json'))
          places = data if isinstance(data, list) else data.get('places', [])
          print(f"Total places: {len(places)}")
          
          # Check required fields (supports both name and name_ar)
          errors = []
          for i, p in enumerate(places):
              name = p.get('name') or p.get('name_ar')
              if not name:
                  errors.append(f"Place {i}: missing name/name_ar")
              cat = p.get('category') or p.get('category_ar')
              if not cat:
                  errors.append(f"Place {i} ({name}): missing category")
          
          if errors:
              print(f"❌ {len(errors)} data errors:")
              for e in errors[:20]:
                  print(f"  {e}")
              exit(1)
          else:
              print(f"✅ All {len(places)} places have required fields")
          
          # Check for duplicates
          names = [p.get('name') or p.get('name_ar','') for p in places]
          dupes = set(n for n in names if names.count(n) > 1)
          if dupes:
              print(f"⚠️ {len(dupes)} potential duplicate names (may be valid - different branches)")
          PYEOF

      - name: Security scan
        run: |
          echo "=== Security Check ==="
          # Check for hardcoded secrets
          if grep -rn "api_key\|secret_key\|password.*=" --include="*.js" --include="*.json" --include="*.html" . 2>/dev/null | grep -v "node_modules" | grep -iv "placeholder\|example\|test\|todo"; then
            echo "⚠️ Potential secrets found — review above"
          else
            echo "✅ No hardcoded secrets detected"
          fi

  validate-html:
    name: Validate HTML
    runs-on: ubuntu-latest
    needs: preflight
    steps:
      - uses: actions/checkout@v4
      - name: Check HTML syntax
        run: |
          error_count=0
          for f in *.html; do
            # Basic structure check
            if ! grep -q "<!DOCTYPE html>" "$f"; then
              echo "⚠️ $f: missing DOCTYPE"
              error_count=$((error_count + 1))
            fi
            if ! grep -q '<html.*lang="ar"' "$f"; then
              echo "⚠️ $f: missing Arabic lang attribute"
            fi
          done
          echo "HTML validation complete. Issues: $error_count"

  validate-js:
    name: Validate JavaScript
    runs-on: ubuntu-latest
    needs: preflight
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - name: Syntax check JS files
        run: |
          for f in js/*.js; do
            node --check "$f" && echo "✅ $f" || echo "❌ $f"
          done
