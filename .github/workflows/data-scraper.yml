# Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ â€” Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø¹Ø¯ ÙƒÙ„ ØªØ­Ø¯ÙŠØ«
name: Data Scraper (Daily)

on:
  schedule:
    - cron: '0 6 * * *'  # 9 AM Riyadh (UTC+3)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scrape-and-validate:
    name: "ğŸ“Š Update & Validate Data"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install requests beautifulsoup4

      # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      - name: Pre-scrape validation
        run: |
          python3 << 'PYEOF'
          import json, os
          for f in ['data/places.json', 'data/delivery-prices.json']:
              if os.path.exists(f):
                  data = json.load(open(f))
                  count = len(data) if isinstance(data, list) else len(data.get('places', data.get('prices', [])))
                  print(f"âœ… {f}: valid ({count} items)")
          PYEOF

      # Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
      - name: Snapshot before scrape
        run: |
          mkdir -p /tmp/data-backup
          cp data/*.json /tmp/data-backup/ 2>/dev/null || true
          echo "ğŸ“¸ Snapshot saved"

      # Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ â€” Ù„Ø§ Ù†Ù‚Ø¨Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø³Ø¯Ø©
      - name: Post-scrape validation
        id: validate
        run: |
          python3 << 'PYEOF'
          import json, os, sys
          errors = 0
          for f in ['data/places.json', 'data/delivery-prices.json']:
              if not os.path.exists(f): continue
              try:
                  data = json.load(open(f))
                  items = data if isinstance(data, list) else data.get('places', data.get('prices', []))
                  if len(items) == 0:
                      print(f"âŒ {f}: empty after scrape!"); errors += 1
                  else:
                      print(f"âœ… {f}: {len(items)} items")
              except json.JSONDecodeError:
                  print(f"âŒ {f}: invalid JSON!"); errors += 1
          if errors:
              print("ğŸ”„ Restoring backup...")
              os.system("cp /tmp/data-backup/*.json data/ 2>/dev/null")
          with open(os.environ['GITHUB_OUTPUT'], 'a') as out:
              out.write(f"errors={errors}\n")
          sys.exit(1 if errors else 0)
          PYEOF

      # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙÙ‚Ø· Ø¥Ø°Ø§ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ù„ÙŠÙ…Ø©
      - name: Auto-commit if valid
        if: steps.validate.outputs.errors == '0'
        run: |
          git config user.name "WainNrooh Bot"
          git config user.email "bot@wain-nrooh.com"
          git add data/
          if git diff --staged --quiet; then
            echo "ğŸ“­ No data changes"
          else
            # Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚
            added=$(git diff --staged --stat | tail -1)
            git commit -m "ğŸ¤– ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: $(date +%Y-%m-%d) â€” $added"
            git push
            echo "âœ… Data committed and pushed"
          fi

      # Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…ØªØµÙØ­ â€” Ø§Ù„ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ø³Ø§ Ø´ØºØ§Ù„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
      - name: Post-deploy smoke test
        if: steps.validate.outputs.errors == '0'
        run: |
          sleep 30  # Ø§Ù†ØªØ¸Ø§Ø± GitHub Pages
          BASE="https://treklaps.github.io/riyadh-places"
          for page in "/" "/discover.html"; do
            status=$(curl -s -o /dev/null -w "%{http_code}" "${BASE}${page}")
            echo "ğŸŒ ${page} â†’ HTTP ${status}"
          done
