#!/usr/bin/env python3
"""Normalize neighborhood names in places.json to canonical forms."""
import json

DATA_PATH = '/home/ubuntu/.openclaw/workspace/projects/riyadh-places/data/places.json'

# Mapping: variant → canonical name
MERGE_MAP = {
    # العليا
    "العليا": "حي العليا",
    # الملقا
    "الملقا": "حي الملقا",
    # حطين
    "حطين": "حي حطين",
    # الياسمين
    "الياسمين": "حي الياسمين",
    # النرجس
    "النرجس": "حي النرجس",
    # الصحافة
    "الصحافة": "حي الصحافة",
    # العقيق
    "العقيق": "حي العقيق",
    # السليمانية
    "السليمانية": "حي السليمانية",
    # الملز
    "الملز": "حي الملز",
    # الحمراء
    "الحمراء": "حي الحمراء",
    # الربوة
    "الربوة": "حي الربوة",
    # المربع
    "المربع": "حي المربع",
    # الديرة
    "الديرة": "حي الديرة",
    # النفل
    "النفل": "حي النفل",
    # السويدي
    "السويدي": "حي السويدي",
    # KAFD
    "حي كافد": "حي الملك عبدالله المالي",
    "KAFD": "حي الملك عبدالله المالي",
    # الدرعية variants
    "الدرعية": "حي الدرعية",
    "الدرعية (البجيري)": "حي الدرعية",
    "الدرعية (جاكس)": "حي الدرعية",
    "الدرعية التاريخية": "حي الدرعية",
    # الرمال
    "الرمال": "حي الرمال",
    # الملك فهد
    "الملك فهد": "حي الملك فهد",
    # المنصورة
    "المنصورة": "حي المنصورة",
    # الحي الدبلوماسي
    "الحي الدبلوماسي": "حي الدبلوماسي",
    # المعيقلية
    "المعيقلية": "حي المعيقلية",
    # المغرزات
    "المغرزات": "حي المغرزات",
    # المعذر
    "المعذر": "حي المعذر",
    # السلام
    "السلام": "حي السلام",
    # القيروان
    "القيروان": "حي القيروان",
    # المونسية
    "المونسية": "حي المونسية",
    # العمارية
    "العمارية": "حي العمارية",
    # الشهداء
    "الشهداء": "حي الشهداء",
    # الوشام
    "الوشام": "حي الوشام",
    # الواحة
    "الواحة": "حي الواحة",
    # الوصيل
    "الوصيل": "حي الوصيل",
    # بانبان / بنبان
    "بانبان": "بنبان",
    # المحمدية
    "المحمدية": "حي المحمدية",
    # الخزامى
    "الخزامى": "حي الخزامى",
    # الملك عبدالعزيز
    "الملك عبدالعزيز": "حي الملك عبدالعزيز",
    # الملك عبدالله
    "الملك عبدالله": "حي الملك عبدالله",
    # الرفيعة
    "الرفيعة": "حي الرفيعة",
    # المنفوحة
    "المنفوحة": "حي المنفوحة",
    # السويدي الغربي → merge into حي السويدي
    "السويدي الغربي": "حي السويدي",
    # ضاحية نمار → نمار
    "ضاحية نمار": "نمار",
    # الأندلس
    "الأندلس": "حي الأندلس",
    # قرطبة
    "قرطبة": "حي قرطبة",
    # جرير
    "جرير": "حي جرير",
    # الجنادرية
    "الجنادرية": "حي الجنادرية",
    # الثمامة
    "الثمامة": "حي الثمامة",
    # ظهرة لبن
    "ظهرة لبن": "حي ظهرة لبن",
    # وادي لبن
    "وادي لبن": "حي وادي لبن",
    # الحاير
    "الحاير": "حي الحاير",
    # المطار الشمالي
    "المطار الشمالي": "حي المطار الشمالي",
}

def normalize():
    with open(DATA_PATH, 'r', encoding='utf-8') as f:
        data = json.load(f)
    
    changes = {}
    for place in data:
        old = place.get('neighborhood', '')
        if old in MERGE_MAP:
            new = MERGE_MAP[old]
            place['neighborhood'] = new
            changes[old] = changes.get(old, 0) + 1
    
    with open(DATA_PATH, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=2)
    
    print(f"Normalized {sum(changes.values())} places across {len(changes)} variants:")
    for old, count in sorted(changes.items(), key=lambda x: -x[1]):
        print(f"  '{old}' → '{MERGE_MAP[old]}' ({count} places)")
    
    # Print final counts
    neighborhoods = {}
    for p in data:
        n = p.get('neighborhood', '')
        if n:
            neighborhoods[n] = neighborhoods.get(n, 0) + 1
    
    print(f"\n--- Final: {len(neighborhoods)} unique neighborhoods ---")
    for n, c in sorted(neighborhoods.items(), key=lambda x: -x[1]):
        print(f"  {n}: {c}")

if __name__ == '__main__':
    normalize()
