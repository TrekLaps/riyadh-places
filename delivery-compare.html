<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/svg+xml" href="images/icon-192.svg">
  <title>ğŸ›µ Ù‚Ø§Ø±Ù† Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØªÙˆØµÙŠÙ„ â€” ÙˆÙŠÙ† Ù†Ø±ÙˆØ­ Ø¨Ø§Ù„Ø±ÙŠØ§Ø¶ØŸ</title>
  <meta name="description" content="Ù‚Ø§Ø±Ù† Ø£Ø³Ø¹Ø§Ø± Ù†ÙØ³ Ø§Ù„Ù…Ø·Ø¹Ù… Ø¹Ø¨Ø± ÙƒÙ„ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ â€” Ù‡Ù†Ù‚Ø±Ø³ØªÙŠØ´Ù†ØŒ Ø¬Ø§Ù‡Ø²ØŒ ØªÙˆÙŠÙˆØŒ ÙƒØ§Ø±ÙŠØ¯Ø¬ØŒ Ø°Ø§ Ø´ÙØ²ØŒ ÙƒÙŠØªØ§ØŒ Ù†ÙŠÙ†Ø¬Ø§ØŒ Ù…Ø±Ø³ÙˆÙ„. ÙˆÙÙ‘Ø± Ø¹Ù„Ù‰ ÙƒÙ„ Ø·Ù„Ø¨!">
  <meta name="keywords" content="Ù…Ù‚Ø§Ø±Ù†Ø© Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØªÙˆØµÙŠÙ„, Ù‡Ù†Ù‚Ø±Ø³ØªÙŠØ´Ù†, Ø¬Ø§Ù‡Ø², ØªÙˆÙŠÙˆ, ÙƒØ§Ø±ÙŠØ¯Ø¬, Ø°Ø§ Ø´ÙØ², ÙƒÙŠØªØ§, Ù†ÙŠÙ†Ø¬Ø§, Ù…Ø±Ø³ÙˆÙ„, ØªÙˆØµÙŠÙ„ Ù…Ø·Ø§Ø¹Ù… Ø§Ù„Ø±ÙŠØ§Ø¶, Ø£Ø±Ø®Øµ ØªØ·Ø¨ÙŠÙ‚ ØªÙˆØµÙŠÙ„">
  <link rel="canonical" href="https://treklaps.github.io/riyadh-places/delivery-compare.html">
  <meta property="og:title" content="ğŸ›µ Ù‚Ø§Ø±Ù† Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØªÙˆØµÙŠÙ„ â€” ÙˆÙŠÙ† Ù†Ø±ÙˆØ­ Ø¨Ø§Ù„Ø±ÙŠØ§Ø¶ØŸ">
  <meta property="og:description" content="Ù‚Ø§Ø±Ù† Ø£Ø³Ø¹Ø§Ø± Ù†ÙØ³ Ø§Ù„Ù…Ø·Ø¹Ù… Ø¹Ø¨Ø± 8 ØªØ·Ø¨ÙŠÙ‚Ø§Øª ØªÙˆØµÙŠÙ„ â€” ÙˆÙÙ‘Ø± Ø¹Ù„Ù‰ ÙƒÙ„ Ø·Ù„Ø¨">
  <meta property="og:url" content="https://treklaps.github.io/riyadh-places/delivery-compare.html">
  <meta property="og:locale" content="ar_SA">
  <meta property="og:image" content="https://treklaps.github.io/riyadh-places/images/icon-512.svg">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0a1628">
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preload" href="data/delivery-prices-full.json" as="fetch" crossorigin>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Tajawal',sans-serif;background:#0a1628;color:#e0e0e0;direction:rtl;min-height:100vh}
    a{color:#c9a84c;text-decoration:none}
    .header{background:linear-gradient(135deg,#0a1628 0%,#1a2a4a 100%);padding:12px 20px;position:sticky;top:0;z-index:100;border-bottom:1px solid rgba(201,168,76,0.2)}
    .header-inner{display:flex;align-items:center;justify-content:space-between;max-width:1400px;margin:auto}
    .logo{text-decoration:none;color:#c9a84c;display:flex;align-items:center;gap:8px}
    .logo h1{font-size:1.2rem;margin:0}
    .back-link{color:#c9a84c;font-size:14px;display:flex;align-items:center;gap:4px}
  </style>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .dc-hero{background:linear-gradient(135deg,#0a1628 0%,#162040 50%,#1a2d50 100%);color:#fff;padding:50px 20px 45px;text-align:center;position:relative;overflow:hidden}
    .dc-hero::after{content:'';position:absolute;bottom:0;left:0;right:0;height:4px;background:linear-gradient(90deg,transparent,#c9a84c,transparent)}
    .dc-hero h2{font-size:2rem;font-weight:900;margin-bottom:12px}
    .dc-hero h2 span{color:#c9a84c}
    .dc-hero p{font-size:16px;color:rgba(255,255,255,0.7);max-width:600px;margin:0 auto;line-height:1.8}
    .dc-stats{display:flex;gap:16px;justify-content:center;flex-wrap:wrap;margin-top:20px}
    .dc-stat{background:rgba(201,168,76,0.1);border:1px solid rgba(201,168,76,0.2);border-radius:12px;padding:12px 20px;text-align:center}
    .dc-stat .num{font-size:1.5rem;font-weight:900;color:#c9a84c}
    .dc-stat .lbl{font-size:13px;color:rgba(255,255,255,0.6)}

    .container{max-width:1400px;margin:0 auto;padding:20px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:24px}
    .search-input{flex:1;min-width:200px;padding:12px 16px;border-radius:12px;border:1px solid rgba(201,168,76,0.3);background:#1c2333;color:#e0e0e0;font-family:inherit;font-size:15px}
    .search-input::placeholder{color:#666}
    .search-input:focus{outline:none;border-color:#c9a84c;box-shadow:0 0 0 3px rgba(201,168,76,0.15)}
    select.filter-select{padding:12px 16px;border-radius:12px;border:1px solid rgba(201,168,76,0.3);background:#1c2333;color:#e0e0e0;font-family:inherit;font-size:14px;cursor:pointer}
    select.filter-select:focus{outline:none;border-color:#c9a84c}

    .apps-legend{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px}
    .app-badge{display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:20px;font-size:13px;font-weight:600}
    .app-badge .dot{width:10px;height:10px;border-radius:50%}

    .table-wrap{overflow-x:auto;border-radius:16px;border:1px solid rgba(201,168,76,0.15);margin-bottom:30px}
    table{width:100%;border-collapse:collapse;min-width:900px}
    thead{background:#162040}
    th{padding:14px 12px;font-weight:700;font-size:14px;color:#c9a84c;text-align:center;border-bottom:2px solid rgba(201,168,76,0.3);white-space:nowrap}
    th:first-child{text-align:right;min-width:180px}
    td{padding:12px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.06);font-size:14px;vertical-align:top}
    td:first-child{text-align:right;font-weight:600}
    tr:hover{background:rgba(201,168,76,0.04)}
    .best-price{background:rgba(34,197,94,0.12);color:#22c55e;font-weight:700;border-radius:8px;padding:2px 6px}
    .not-available{color:#555;font-style:italic;font-size:12px}
    .app-cell{display:flex;flex-direction:column;align-items:center;gap:4px}
    .app-cell .price{font-size:16px;font-weight:700}
    .app-cell .items{font-size:11px;color:#888;max-width:150px;line-height:1.4}
    .restaurant-name{color:#c9a84c}
    .restaurant-cat{font-size:12px;color:#888;font-weight:400}
    .restaurant-rating{display:inline-flex;align-items:center;gap:3px;font-size:12px;color:#f59e0b;margin-top:2px}
    
    .detail-modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:200;align-items:center;justify-content:center;padding:20px}
    .detail-modal.active{display:flex}
    .detail-content{background:#1c2333;border-radius:20px;max-width:800px;width:100%;max-height:85vh;overflow-y:auto;padding:30px;border:1px solid rgba(201,168,76,0.2)}
    .detail-close{position:absolute;top:15px;left:15px;background:none;border:none;color:#fff;font-size:24px;cursor:pointer}
    .detail-header{margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid rgba(201,168,76,0.2)}
    .detail-header h3{font-size:1.4rem;color:#c9a84c;margin-bottom:4px}
    .detail-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px}
    .detail-app-card{background:#0a1628;border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.08)}
    .detail-app-card h4{color:#c9a84c;margin-bottom:10px;font-size:15px}
    .detail-item{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.04);font-size:13px}
    .detail-item .item-price{color:#c9a84c;font-weight:600}
    
    .summary-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:30px}
    .summary-card{background:#1c2333;border-radius:16px;padding:20px;border:1px solid rgba(201,168,76,0.15)}
    .summary-card h3{color:#c9a84c;font-size:16px;margin-bottom:12px}
    .summary-card .info{font-size:14px;line-height:1.8;color:#aaa}
    .summary-card .info strong{color:#e0e0e0}
    
    .loading{text-align:center;padding:60px;color:#888;font-size:18px}
    .result-count{color:#888;font-size:14px;margin-bottom:16px}
    
    .footer{background:#0d1117;padding:30px 20px;text-align:center;color:#555;font-size:13px;border-top:1px solid rgba(201,168,76,0.1);margin-top:40px}
    .footer a{color:#c9a84c}

    @media(max-width:768px){
      .dc-hero{padding:30px 16px 25px}
      .dc-hero h2{font-size:1.5rem}
      .container{padding:16px}
      .controls{flex-direction:column}
      .search-input,.filter-select{width:100%}
      .dc-stats{gap:8px}
      .dc-stat{padding:8px 14px}
      .dc-stat .num{font-size:1.2rem}
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="logo"><h1>ğŸ™ï¸ ÙˆÙŠÙ† Ù†Ø±ÙˆØ­</h1></a>
      <a href="index.html" class="back-link">â† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    </div>
  </header>

  <section class="dc-hero">
    <h2>ğŸ›µ <span>Ù‚Ø§Ø±Ù† Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØªÙˆØµÙŠÙ„</span></h2>
    <p>Ù†ÙØ³ Ø§Ù„Ù…Ø·Ø¹Ù… Ø¨Ø£Ø³Ø¹Ø§Ø± Ù…Ø®ØªÙ„ÙØ©! Ø´ÙˆÙ Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ù¨ ØªØ·Ø¨ÙŠÙ‚Ø§Øª ØªÙˆØµÙŠÙ„ ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ ÙˆÙˆÙÙ‘Ø± Ø¹Ù„Ù‰ ÙƒÙ„ Ø·Ù„Ø¨</p>
    <div class="dc-stats" id="heroStats"></div>
  </section>

  <div class="container">
    <!-- App Info Cards -->
    <div class="summary-cards" id="appInfoCards"></div>

    <!-- Controls -->
    <div class="controls">
      <input type="text" class="search-input" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø·Ø¹Ù…...">
      <select class="filter-select" id="categoryFilter">
        <option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>
      </select>
      <select class="filter-select" id="sortSelect">
        <option value="name">ØªØ±ØªÙŠØ¨ Ø£Ø¨Ø¬Ø¯ÙŠ</option>
        <option value="cheapest">Ø§Ù„Ø£Ø±Ø®Øµ Ø£ÙˆÙ„Ø§Ù‹</option>
        <option value="most-apps">Ø§Ù„Ø£ÙƒØ«Ø± ØªØ·Ø¨ÙŠÙ‚Ø§Øª</option>
        <option value="rating">Ø§Ù„Ø£Ø¹Ù„Ù‰ ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹</option>
      </select>
    </div>

    <div class="result-count" id="resultCount"></div>

    <div id="loading" class="loading">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>

    <!-- Main Table -->
    <div class="table-wrap" id="tableWrap" style="display:none">
      <table>
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Detail Modal -->
  <div class="detail-modal" id="detailModal">
    <div class="detail-content" id="detailContent"></div>
  </div>

  <footer class="footer">
    <p>âš ï¸ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ØªÙ‚Ø±ÙŠØ¨ÙŠØ© ÙˆÙ‚Ø¯ ØªØ®ØªÙ„Ù Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹ ÙˆØ§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„Ø¹Ø±ÙˆØ¶</p>
    <p style="margin-top:8px">ÙˆÙŠÙ† Ù†Ø±ÙˆØ­ Ø¨Ø§Ù„Ø±ÙŠØ§Ø¶ØŸ â€” <a href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a> | <a href="prices.html">Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…Ø·Ø§Ø¹Ù…</a> | <a href="best.html">Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ù…Ø§ÙƒÙ†</a></p>
  </footer>

<script>
const APP_COLORS = {
  hungerstation: '#e11d48',
  jahez: '#7c3aed',
  toyou: '#2563eb',
  carriage: '#059669',
  thechefz: '#d97706',
  keeta: '#06b6d4',
  ninja: '#f97316',
  mrsool: '#8b5cf6'
};
const APP_NAMES = {
  hungerstation: 'Ù‡Ù†Ù‚Ø±Ø³ØªÙŠØ´Ù†',
  jahez: 'Ø¬Ø§Ù‡Ø²',
  toyou: 'ØªÙˆÙŠÙˆ',
  carriage: 'ÙƒØ§Ø±ÙŠØ¯Ø¬',
  thechefz: 'Ø°Ø§ Ø´ÙØ²',
  keeta: 'ÙƒÙŠØªØ§',
  ninja: 'Ù†ÙŠÙ†Ø¬Ø§',
  mrsool: 'Ù…Ø±Ø³ÙˆÙ„'
};

let allRestaurants = [];
let appsInfo = {};
let activeApps = [];

async function loadData() {
  try {
    const [fullRes, ninjaRes] = await Promise.all([
      fetch('data/delivery-prices-full.json').then(r => r.json()),
      fetch('data/ninja-mrsool-prices.json').then(r => r.json())
    ]);

    appsInfo = fullRes.delivery_apps_info || {};
    
    // Add ninja/mrsool info
    if (ninjaRes.apps_overview) {
      for (const [key, val] of Object.entries(ninjaRes.apps_overview)) {
        appsInfo[key] = val;
      }
    }
    
    // Merge restaurant data
    const restaurantMap = new Map();
    
    // Add main data
    for (const r of fullRes.restaurants) {
      const key = r.restaurant_ar || r.restaurant;
      const entry = { ...r, apps_data: {} };
      for (const app of r.apps || []) {
        entry.apps_data[app.app] = app;
      }
      restaurantMap.set(key, entry);
    }
    
    // Merge ninja/mrsool
    for (const r of (ninjaRes.restaurants || [])) {
      const key = r.restaurant || r.restaurant_en;
      let entry = null;
      // Try to find match
      for (const [k, v] of restaurantMap) {
        if (k === key || v.restaurant === r.restaurant_en || v.restaurant_ar === r.restaurant) {
          entry = v;
          break;
        }
      }
      if (!entry) {
        entry = { restaurant: r.restaurant_en || r.restaurant, restaurant_ar: r.restaurant || r.restaurant_en, category: r.type || '', rating: 0, apps_data: {} };
        restaurantMap.set(entry.restaurant_ar, entry);
      }
      if (r.apps) {
        for (const [appName, appData] of Object.entries(r.apps)) {
          if (appData.available) {
            entry.apps_data[appName] = {
              app: appName,
              available: true,
              items: (appData.items || []).map(i => ({
                name: i.name,
                price: typeof i.price === 'string' ? parseFloat(i.price) : i.price
              })),
              delivery_fee: appData.delivery_fee || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'
            };
          }
        }
      }
    }
    
    allRestaurants = Array.from(restaurantMap.values());
    
    // Determine which apps exist
    const appSet = new Set();
    for (const r of allRestaurants) {
      for (const key of Object.keys(r.apps_data)) {
        appSet.add(key);
      }
    }
    activeApps = ['hungerstation','jahez','toyou','carriage','thechefz','keeta','ninja','mrsool'].filter(a => appSet.has(a));
    
    buildUI();
  } catch(e) {
    document.getElementById('loading').innerHTML = 'âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + e.message;
    console.error(e);
  }
}

function buildUI() {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('tableWrap').style.display = 'block';
  
  // Hero stats
  document.getElementById('heroStats').innerHTML = `
    <div class="dc-stat"><div class="num">${allRestaurants.length}</div><div class="lbl">Ù…Ø·Ø¹Ù…</div></div>
    <div class="dc-stat"><div class="num">${activeApps.length}</div><div class="lbl">ØªØ·Ø¨ÙŠÙ‚ ØªÙˆØµÙŠÙ„</div></div>
    <div class="dc-stat"><div class="num">${allRestaurants.reduce((s,r) => s + Object.values(r.apps_data).reduce((a,app) => a + (app.items?.length||0), 0), 0)}+</div><div class="lbl">ØµÙ†Ù</div></div>
  `;
  
  // App info cards
  const infoHtml = activeApps.map(app => {
    const info = appsInfo[app] || {};
    return `<div class="summary-card">
      <h3><span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:${APP_COLORS[app]};margin-left:8px"></span>${APP_NAMES[app]}</h3>
      <div class="info">
        ${info.typical_delivery_fee ? `<div>ğŸšš Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„: <strong>${info.typical_delivery_fee}</strong></div>` : ''}
        ${info.min_order ? `<div>ğŸ“¦ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰: <strong>${info.min_order}</strong></div>` : ''}
        ${info.coverage ? `<div>ğŸ“ Ø§Ù„ØªØºØ·ÙŠØ©: <strong>${info.coverage}</strong></div>` : ''}
        ${info.restaurants_count ? `<div>ğŸ½ï¸ Ø§Ù„Ù…Ø·Ø§Ø¹Ù…: <strong>${info.restaurants_count}</strong></div>` : ''}
        ${info.subscription ? `<div>â­ Ø§Ø´ØªØ±Ø§Ùƒ: <strong>${info.subscription}</strong></div>` : ''}
      </div>
    </div>`;
  }).join('');
  document.getElementById('appInfoCards').innerHTML = infoHtml;
  
  // Categories
  const cats = [...new Set(allRestaurants.map(r => r.category).filter(Boolean))];
  const catSelect = document.getElementById('categoryFilter');
  cats.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    catSelect.appendChild(opt);
  });
  
  // Table header
  document.getElementById('tableHead').innerHTML = `<tr>
    <th>Ø§Ù„Ù…Ø·Ø¹Ù…</th>
    ${activeApps.map(a => `<th><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${APP_COLORS[a]};margin-left:4px"></span>${APP_NAMES[a]}</th>`).join('')}
    <th>Ø§Ù„Ø£Ø±Ø®Øµ</th>
  </tr>`;
  
  renderTable();
  
  // Events
  document.getElementById('searchInput').addEventListener('input', renderTable);
  document.getElementById('categoryFilter').addEventListener('change', renderTable);
  document.getElementById('sortSelect').addEventListener('change', renderTable);
}

function getAvgPrice(appData) {
  if (!appData?.items?.length) return Infinity;
  const prices = appData.items.map(i => typeof i.price === 'number' ? i.price : parseFloat(i.price)).filter(p => !isNaN(p) && p > 0);
  return prices.length ? prices.reduce((a,b)=>a+b,0)/prices.length : Infinity;
}

function renderTable() {
  const query = document.getElementById('searchInput').value.trim().toLowerCase();
  const cat = document.getElementById('categoryFilter').value;
  const sort = document.getElementById('sortSelect').value;
  
  let filtered = allRestaurants.filter(r => {
    if (query && !(r.restaurant_ar||'').includes(query) && !(r.restaurant||'').toLowerCase().includes(query)) return false;
    if (cat && r.category !== cat) return false;
    return true;
  });
  
  // Sort
  if (sort === 'cheapest') {
    filtered.sort((a,b) => {
      const aMin = Math.min(...activeApps.map(app => getAvgPrice(a.apps_data[app])));
      const bMin = Math.min(...activeApps.map(app => getAvgPrice(b.apps_data[app])));
      return aMin - bMin;
    });
  } else if (sort === 'most-apps') {
    filtered.sort((a,b) => Object.keys(b.apps_data).length - Object.keys(a.apps_data).length);
  } else if (sort === 'rating') {
    filtered.sort((a,b) => (b.rating||0) - (a.rating||0));
  } else {
    filtered.sort((a,b) => (a.restaurant_ar||'').localeCompare(b.restaurant_ar||'', 'ar'));
  }
  
  document.getElementById('resultCount').textContent = `Ø¹Ø±Ø¶ ${filtered.length} Ù…Ø·Ø¹Ù… Ù…Ù† ${allRestaurants.length}`;
  
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = filtered.map((r, idx) => {
    // Find cheapest app
    let cheapestApp = null, cheapestAvg = Infinity;
    for (const app of activeApps) {
      const avg = getAvgPrice(r.apps_data[app]);
      if (avg < cheapestAvg) { cheapestAvg = avg; cheapestApp = app; }
    }
    
    return `<tr onclick="showDetail(${idx})" style="cursor:pointer" data-idx="${idx}">
      <td>
        <div class="restaurant-name">${r.restaurant_ar || r.restaurant}</div>
        <div class="restaurant-cat">${r.category || ''}</div>
        ${r.rating ? `<div class="restaurant-rating">â­ ${r.rating}</div>` : ''}
      </td>
      ${activeApps.map(app => {
        const d = r.apps_data[app];
        if (!d?.available && !d?.items?.length) return `<td><span class="not-available">ØºÙŠØ± Ù…ØªÙˆÙØ±</span></td>`;
        const avg = getAvgPrice(d);
        const isCheapest = app === cheapestApp && cheapestAvg < Infinity;
        const itemCount = d.items?.length || 0;
        return `<td>
          <div class="app-cell">
            <div class="price ${isCheapest ? 'best-price' : ''}">${avg < Infinity ? Math.round(avg) + ' Ø±.Ø³' : '-'}</div>
            <div class="items">${itemCount} ØµÙ†Ù</div>
          </div>
        </td>`;
      }).join('')}
      <td>${cheapestApp ? `<span style="color:${APP_COLORS[cheapestApp]};font-weight:700">${APP_NAMES[cheapestApp]}</span>` : '-'}</td>
    </tr>`;
  }).join('');
  
  // Store filtered for detail modal
  window._filtered = filtered;
}

function showDetail(idx) {
  const r = window._filtered[idx];
  if (!r) return;
  
  const modal = document.getElementById('detailModal');
  const content = document.getElementById('detailContent');
  
  let html = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <div class="detail-header" style="border:0;margin:0;padding:0">
        <h3>${r.restaurant_ar || r.restaurant}</h3>
        <div style="color:#888;font-size:14px">${r.category || ''} ${r.rating ? 'â­ ' + r.rating : ''} ${r.price_range ? '| ' + r.price_range : ''}</div>
      </div>
      <button onclick="closeDetail()" style="background:none;border:none;color:#fff;font-size:28px;cursor:pointer">âœ•</button>
    </div>
    <div class="detail-grid">
  `;
  
  for (const app of activeApps) {
    const d = r.apps_data[app];
    if (!d?.items?.length) continue;
    html += `<div class="detail-app-card">
      <h4><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${APP_COLORS[app]};margin-left:6px"></span>${APP_NAMES[app]}</h4>
      ${d.delivery_fee ? `<div style="font-size:12px;color:#888;margin-bottom:8px">ğŸšš ${typeof d.delivery_fee === 'object' ? JSON.stringify(d.delivery_fee) : d.delivery_fee}</div>` : ''}
      ${d.items.slice(0, 10).map(item => `<div class="detail-item">
        <span>${item.name}</span>
        <span class="item-price">${typeof item.price === 'number' ? item.price + ' Ø±.Ø³' : item.price || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</span>
      </div>`).join('')}
      ${d.items.length > 10 ? `<div style="text-align:center;color:#888;font-size:12px;margin-top:8px">+ ${d.items.length - 10} ØµÙ†Ù Ø¢Ø®Ø±</div>` : ''}
    </div>`;
  }
  
  html += '</div>';
  content.innerHTML = html;
  modal.classList.add('active');
}

function closeDetail() {
  document.getElementById('detailModal').classList.remove('active');
}

document.getElementById('detailModal').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeDetail();
});

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeDetail(); });

loadData();
</script>
</body>
</html>
